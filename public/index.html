<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Null Downloader - å‹•ç”»ãƒ»éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1>Null Downloader</h1>
      <p>å‹•ç”»ãƒ»éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <!-- URLå…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="input-section">
        <div class="input-wrapper">
          <input type="text" id="urlInput"
            placeholder="https://www.youtube.com/watch?v=... (YouTube, TikTok, Vimeo, etc.)" autocomplete="off">
          <button id="analyzeBtn" onclick="startDownload()">è§£æã™ã‚‹</button>
        </div>

        <!-- Cookieå…¥åŠ›ç”¨ (IPåˆ¶é™å›é¿) -->
        <details class="advanced-settings"
          style="margin-top: 15px; border: 1px solid #444; padding: 10px; border-radius: 5px;">
          <summary style="cursor: pointer; color: #aaa; user-select: none;">é«˜åº¦ãªè¨­å®š: YouTube Cookies (å¹´é½¢åˆ¶é™ãƒ»IPãƒ–ãƒ­ãƒƒã‚¯å›é¿ç”¨)
          </summary>
          <div style="margin-top: 10px;">
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">
              Renderã‚µãƒ¼ãƒãƒ¼ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å–å¾—ã—ãŸNetscapeå½¢å¼ã®Cookieã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
              æ‹¡å¼µæ©Ÿèƒ½ã€ŒGet cookies.txt LOCALLYã€ãªã©ã§å–å¾—ã§ãã¾ã™ã€‚
            </p>
            <textarea id="cookieInput" placeholder="# Netscape HTTP Cookie File..."
              style="width: 100%; height: 80px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px; font-family: monospace; font-size: 10px;"></textarea>
          </div>
        </details>
      </div>

      <!-- ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="thumbnail-section" id="thumbnailSection" style="display: none;">
        <div class="thumbnail-container">
          <img id="videoThumbnail" src="" alt="Video Thumbnail" style="display: none;">
          <div id="soundOnlyPlaceholder" class="sound-only-placeholder" style="display: none;">
            <span>ğŸµ</span>
            <p>Sound Only</p>
          </div>
        </div>
        <div class="video-title" id="videoTitle"></div>
      </div>

      <!-- çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="quality-section" id="qualitySection">
        <div class="quality-group">
          <label for="formatSelector">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠ:</label>
          <div class="quality-controls">
            <select id="formatSelector" disabled>
              <option value="">è§£æã—ã¦ãã ã•ã„</option>
            </select>
            <button onclick="downloadSelected()" id="downloadBtn" disabled>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div class="status info" id="status">
        <span class="status-icon">â„¹ï¸</span>
        <span class="status-text">URLã‚’å…¥åŠ›ã—ã¦è§£æãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>
      </div>

      <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²æ—ãƒãƒ¼ -->
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
          <span class="progress-text" id="progressText">0% Download</span>
        </div>
      </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="footer">
      <p>å€‹äººåˆ©ç”¨ç›®çš„ã®ã¿ã€‚è‘—ä½œæ¨©æ³•ã‚’éµå®ˆã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
    </div>
  </div>

  <script>
    let currentVideoFormats = [];
    let currentUrl = '';
    let currentVideoTitle = '';

    // ãƒ‘ã‚¿ãƒ¼ãƒ³B: URLè§£ææ©Ÿèƒ½
    async function startDownload() {
      const urlInput = document.getElementById('urlInput');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const url = urlInput.value.trim();
      const cookies = document.getElementById('cookieInput').value.trim();

      if (!url) {
        updateStatus('error', 'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!isValidUrl(url)) {
        updateStatus('error', 'æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      currentUrl = url;

      try {
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'è§£æä¸­...';
        updateStatus('loading', 'URLã‚’è§£æã—ã¦ã„ã¾ã™...');

        // URLè§£æ
        const response = await fetch('/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, cookies })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'URLè§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        currentVideoFormats = data.video_formats;

        // å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¿å­˜
        if (data.video_info && data.video_info.title) {
          currentVideoTitle = data.video_info.title;
        }

        // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
        displayThumbnail(data.video_info);

        // çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æœ‰åŠ¹åŒ–
        populateFormatSelector();

        const qualitySection = document.getElementById('qualitySection');
        qualitySection.classList.add('active');

        updateStatus('info', `è§£æå®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„`);

      } catch (error) {
        console.error('Error:', error);
        updateStatus('error', error.message);
      } finally {
        // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'è§£æã™ã‚‹';
      }
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºå‡¦ç†
    function displayThumbnail(videoInfo) {
      const thumbnailSection = document.getElementById('thumbnailSection');
      const videoThumbnail = document.getElementById('videoThumbnail');
      const soundOnlyPlaceholder = document.getElementById('soundOnlyPlaceholder');
      const videoTitle = document.getElementById('videoTitle');

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      thumbnailSection.style.display = 'block';

      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
      if (videoInfo && videoInfo.title) {
        videoTitle.textContent = videoInfo.title;
      } else {
        videoTitle.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜';
      }

      if (videoInfo && videoInfo.thumbnail) {
        // ã‚µãƒ ãƒã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
        videoThumbnail.src = videoInfo.thumbnail;
        videoThumbnail.style.display = 'block';
        soundOnlyPlaceholder.style.display = 'none';
      } else {
        // ã‚µãƒ ãƒã‚¤ãƒ«ãŒãªã„å ´åˆã¯ "Sound Only" ã‚’è¡¨ç¤º
        videoThumbnail.style.display = 'none';
        soundOnlyPlaceholder.style.display = 'flex';
      }
    }

    // çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æ§‹ç¯‰
    function populateFormatSelector() {
      const formatSelector = document.getElementById('formatSelector');
      const downloadBtn = document.getElementById('downloadBtn');

      formatSelector.innerHTML = '<option value="">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      // å‹•ç”»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—
      const videoOptgroup = document.createElement('optgroup');
      videoOptgroup.label = 'ğŸ“¹ Video';

      // é‡è¤‡è§£åƒåº¦ã‚’é™¤å»ï¼ˆåŒã˜resolutionã¯1ã¤ã ã‘è¡¨ç¤ºï¼‰
      const uniqueFormats = [];
      const seenResolutions = new Set();

      currentVideoFormats.forEach(format => {
        if (!seenResolutions.has(format.resolution)) {
          seenResolutions.add(format.resolution);
          uniqueFormats.push(format);
        }
      });

      uniqueFormats.forEach(format => {
        const option = document.createElement('option');
        option.value = `video:${format.format_id}`;
        const filesize = format.filesize ? ` (${formatFileSize(format.filesize)})` : '';
        option.textContent = `MP4 (${format.resolution})${filesize}`;
        videoOptgroup.appendChild(option);
      });

      formatSelector.appendChild(videoOptgroup);

      // éŸ³å£°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—
      const audioOptgroup = document.createElement('optgroup');
      audioOptgroup.label = 'ğŸµ Audio';

      const audioFormats = [
        { value: 'mp3', label: 'MP3' },
        { value: 'wav', label: 'WAV' },
        { value: 'm4a', label: 'M4A' },
        { value: 'flac', label: 'FLAC' },
        { value: 'aac', label: 'AAC' }
      ];

      audioFormats.forEach(format => {
        const option = document.createElement('option');
        option.value = `audio:${format.value}`;
        option.textContent = format.label;
        audioOptgroup.appendChild(option);
      });

      formatSelector.appendChild(audioOptgroup);

      formatSelector.disabled = false;
      downloadBtn.disabled = false;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatFileSize(bytes) {
      if (!bytes) return '';
      const mb = bytes / (1024 * 1024);
      if (mb >= 1024) {
        return `${(mb / 1024).toFixed(2)}GB`;
      }
      return `${mb.toFixed(2)}MB`;
    }

    // çµ±åˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    async function downloadSelected() {
      const formatSelector = document.getElementById('formatSelector');
      const selectedValue = formatSelector.value;

      if (!selectedValue) {
        updateStatus('error', 'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // é¸æŠå€¤ã‚’è§£æï¼ˆvideo:format_id ã¾ãŸã¯ audio:formatï¼‰
      const [type, value] = selectedValue.split(':');

      if (type === 'video') {
        // å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        await performDownload(value, 'video', null);
      } else if (type === 'audio') {
        // éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        await performDownload(null, 'audio', value);
      }
    }

    // é€²æ—ãƒãƒ¼æ›´æ–°
    function updateProgress(percent) {
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      progressContainer.style.display = 'block';
      progressFill.style.width = `${percent}%`;
      progressText.textContent = `${percent}% Download`;
    }

    // é€²æ—ãƒãƒ¼ã‚’éš ã™
    function hideProgress() {
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.style.display = 'none';
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    async function performDownload(formatId, downloadType, audioFormat) {
      try {
        // é€²æ—ãƒãƒ¼ã‚’0%ã§è¡¨ç¤º
        updateProgress(0);
        updateStatus('loading', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...');

        const requestBody = {
          url: currentUrl,
          format_id: formatId,
          download_type: downloadType,
          cookies: document.getElementById('cookieInput').value.trim()
        };

        // éŸ³å£°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
        if (audioFormat) {
          requestBody.audio_format = audioFormat;
        }

        // å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
        if (currentVideoTitle) {
          requestBody.title = currentVideoTitle;
        }

        const response = await fetch('/download', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // Content-Lengthã‹ã‚‰ç·ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å–å¾—
        const contentLength = response.headers.get('Content-Length');
        const totalSize = parseInt(contentLength, 10);

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
        const contentDisposition = response.headers.get('Content-Disposition');
        let defaultExt = 'mp4';
        if (downloadType === 'audio') {
          defaultExt = audioFormat || 'mp3';
        }
        let filename = currentVideoTitle ? `${currentVideoTitle}.${defaultExt}` : `download.${defaultExt}`;

        if (contentDisposition) {
          const matches = /filename\*?=['"]?(?:UTF-\d['"]*)?([^;\r\n"']*)['"]?;?/.exec(contentDisposition);
          if (matches != null && matches[1]) {
            filename = decodeURIComponent(matches[1]);
          }
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ èª­ã¿å–ã‚Šã§é€²æ—è¡¨ç¤º
        const reader = response.body.getReader();
        const chunks = [];
        let receivedSize = 0;

        while (true) {
          const { done, value } = await reader.read();

          if (done) break;

          chunks.push(value);
          receivedSize += value.length;

          // é€²æ—ç‡ã‚’è¨ˆç®—ã—ã¦æ›´æ–°
          if (totalSize) {
            const percent = Math.round((receivedSize / totalSize) * 100);
            updateProgress(percent);
          }
        }

        // å…¨ãƒãƒ£ãƒ³ã‚¯ã‚’çµåˆã—ã¦Blobã‚’ä½œæˆ
        const blob = new Blob(chunks);

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(downloadUrl);
        document.body.removeChild(a);

        updateStatus('success', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼');
        hideProgress();
      } catch (error) {
        console.error('Error:', error);
        updateStatus('error', error.message);
        hideProgress();
      }
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        return false;
      }
    }

    function updateStatus(type, message) {
      const statusDiv = document.getElementById('status');
      const statusText = statusDiv.querySelector('.status-text');
      const statusIcon = statusDiv.querySelector('.status-icon');

      // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      statusDiv.className = 'status';
      statusDiv.classList.add(type);

      // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
      const icons = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        loading: '<span class="spinner"></span>'
      };

      statusIcon.innerHTML = icons[type] || icons.info;
      statusText.textContent = message;
    }

    // Enterã‚­ãƒ¼ã§è§£æé–‹å§‹
    document.getElementById('urlInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        startDownload();
      }
    });
  </script>
</body>

</html>