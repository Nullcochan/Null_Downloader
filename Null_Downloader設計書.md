個人用動画ダウンローダー 設計書
1. 目的
本ドキュメントは、先に作成した要件定義書に基づき、個人用動画ダウンローダーの具体的な実装方法、画面デザイン、技術的仕様を定めることを目的とする。
2. 設計思想
シンプル＆モダン: 操作に迷わない、直感的でクリーンなUIを提供する。
ダークテーマ: Obsidianのような、目に優しくモダンな印象を与えるダークテーマを基調とする。
単一目的: 主な機能は「URLから動画・音声をダウンロードする」ことに特化させ、余計な機能は含めない。
インタラクティブなUI: ユーザーのアクション（URL入力、解析）に応じて、動的に次の選択肢（品質選択など）を提示し、スムーズな操作感を実現する。
3. システムアーキテクチャ
要件定義書で定めた構成を踏襲する。
code
Code
[ユーザー] <--> [① フロントエンド (HTML/JS)] <--> [② サーバーサイド (Node.js/Express)]
                                                      |
                                                      v
                                        [③ 外部ツール (yt-dlp, FFmpeg)]
                                                      |
                                                      v
                                        [④ 一時ファイルストレージ (tmp/)]
処理の流れ:
ユーザーがブラウザ（フロントエンド）でURLを入力し、「解析」ボタンを押す。
フロントエンドはサーバーサイドAPIにURLを送信する。
サーバーサイドはyt-dlpを使い、URLの動画情報をダウンロードせずに解析する。
サーバーサイドは取得した品質リスト（解像度、形式）をフロントエンドに返す。
フロントエンドは品質リストをドロップダウンメニューなどで表示する。
ユーザーが希望の品質と形式（MP4 or 音声）を選択し、「ダウンロード」ボタンを押す。
フロントエンドはURLと選択した品質情報をサーバーサイドAPIに送信する。
サーバーサイドはyt-dlpとFFmpegを使い、指定された品質で動画/音声をダウンロード・変換し、一時ファイルとして保存する。
サーバーサイドは変換完了したファイルをユーザーにストリーミング送信する。
送信完了後、サーバー上の一時ファイルを削除する。
4. 画面設計 (UI/UX)
テーマ: Obsidian風ダークモード
背景色: ダークグレー (#282c34 など)
テキスト色: ライトグレー (#abb2bf など)
アクセントカラー: ブルーまたはパープル (#61afef など)
4.1. ワイヤーフレーム（画面構成案）
初期表示:
code
Code
+------------------------------------------------------+
|                                                      |
|          個人用動画ダウンローダー                     |
|                                                      |
|  [  https://www.youtube.com/watch?v=...         ] [解析] |
|                                                      |
|  (ステータス表示エリア)                                |
|                                                      |
+------------------------------------------------------+
URL解析後:
code
Code
+------------------------------------------------------+
|                                                      |
|          個人用動画ダウンローダー                     |
|                                                      |
|  [  https://www.youtube.com/watch?v=...         ] [解析] |
|                                                      |
|  動画ダウンロード:                                    |
|  [ 1440p MP4 (256MB) v] [ダウンロード]                 |
|                                                      |
|  音声のみダウンロード:                                |
|  [ MP3 (128kbps) v] [ダウンロード]                     |
|                                                      |
|  (ステータス: 解析完了。フォーマットを選択してください)    |
|                                                      |
+------------------------------------------------------+
v: ドロップダウンメニューを示す記号。
4.2. UIコンポーネント詳細
URL入力欄:
ユーザーが動画ページのURLをペーストする。
プレースホルダーで入力例を示す。
解析ボタン:
クリックするとサーバーにURLを送信し、ダウンロード可能なフォーマット一覧を取得する。
処理中はボタンを無効化し、ローディングインジケータを表示する。
品質選択 (動画):
URL解析後に表示されるドロップダウンメニュー。
yt-dlpから取得した情報に基づき、「1440p」「1080p」「720p」「480p」「360p」「240p」「144p」の選択肢をMP4形式で動的に生成する。ファイルサイズも併記すると親切。
品質選択 (音声):
URL解析後に表示されるドロップダウンメニュー。
「MP3 (高音質)」「WAV (非圧縮)」を選択肢として表示する。
ダウンロードボタン:
選択した品質でダウンロード処理を開始する。
処理中はボタン名を「ダウンロード中...」に変更し無効化する。
ステータス表示エリア:
「URLを入力してください」「解析中...」「ダウンロード中...」「完了しました」「エラー: ...」といった現在の状態をユーザーにフィードバックする。
5. 機能実装設計
5.1. 対応サービス
添付画像にある下記サービスにyt-dlpを用いて対応する。
YouTube
Facebook
SoundCloud
Vimeo
TikTok
IMDb
X (Twitter)
Twitch
5.2. 品質・フォーマット選択機能の実装
この機能は2段階のAPI呼び出しで実装する。
Step 1: 情報解析API (/analyze)
フロントエンドから { url: "..." } を受け取る。
サーバーサイドでyt-dlpの --dump-json または --list-formats オプションを使い、動画をダウンロードせずにメタデータ（利用可能なフォーマット一覧）を取得する。
code
Bash
# 例: JSONで全情報を取得
yt-dlp --dump-json "USER_PROVIDED_URL"
取得した情報から、MP4動画（144p～1440p）と音声のフォーマット情報を抽出し、整理してフロントエンドに返す。
返却データ例:
code
JSON
{
  "videoFormats": [
    { "id": "313", "resolution": "2160p", "ext": "mp4", "size": "300MB" },
    { "id": "137", "resolution": "1080p", "ext": "mp4", "size": "150MB" }
  ],
  "audioFormats": [
    { "id": "mp3", "quality": "192kbps" },
    { "id": "wav", "quality": "PCM" }
  ]
}
Step 2: ダウンロード実行API (/download)
フロントエンドから { url: "...", formatId: "137" } のようなリクエストを受け取る。
受け取ったformatIdを元に、yt-dlpのダウンロードコマンドを組み立てる。
動画ダウンロードの場合 (MP4):
yt-dlpは多くの場合、映像と音声を別々にダウンロードして自動で結合（マージ）する。-fオプションで品質を指定する。
code
Bash
# 例: 1080pの映像 + 最良品質の音声を結合してMP4として出力
yt-dlp -f "137+bestaudio/best" -o "output.mp4" "USER_PROVIDED_URL"
音声のみダウンロードの場合 (MP3/WAV):
-x (--extract-audio) と --audio-format オプションを使用する。
code
Bash
# MP3として抽出
yt-dlp -x --audio-format mp3 -o "output.mp3" "USER_PROVIDED_URL"

# WAVとして抽出
yt-dlp -x --audio-format wav -o "output.wav" "USER_PROVIDED_URL"
生成されたファイルを res.download() でユーザーに送信し、その後一時ファイルを削除する。
6. 技術スタック
フロントエンド: HTML5, CSS3, JavaScript (Fetch API)
サーバーサイド: Node.js, Express
動画・音声処理: yt-dlp, FFmpeg (yt-dlpが内部的に利用)
パッケージ管理: npm
7. ディレクトリ構成
提示された構成案をベースとする。
code
Code
project/
├─ server.js         # Expressサーバーのメインファイル
├─ package.json      # プロジェクト定義と依存ライブラリ
├─ public/           # フロントエンドの静的ファイル
│   ├─ index.html
│   └─ style.css     # デザイン定義ファイル
└─ tmp/              # ダウンロード・変換用の一時ディレクトリ